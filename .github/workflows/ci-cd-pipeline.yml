name: Karate CI/CD

on:
  pull_request:
    types: [opened, synchronize, reopened]
  workflow_dispatch:

permissions:
  id-token: write
  contents: read
  pull-requests: write

jobs:
  setup_environment:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Get Changed Feature Files
      id: changed-feature-files
      uses: tj-actions/changed-files@v46.0.1
      with:
        files: '**.feature'
        only_changed: true

    - name: Check for Feature Files
      id: check_feature_files
      run: |
        if [ "${{ steps.changed-feature-files.outputs.any_changed }}" != 'true' ]; then
          echo "SKIP_TESTS=true" >> $GITHUB_ENV
          echo "No feature files to test. Exiting."
        else
          echo "SKIP_TESTS=false" >> $GITHUB_ENV
          echo "Changed feature files:"
          for file in ${{ steps.changed-feature-files.outputs.all_changed_files }}; do
            echo "$file"
          done
        fi

    - name: Set up JDK 17
      if: ${{ env.SKIP_TESTS == 'false' }}
      uses: actions/setup-java@v3
      with:
        distribution: 'temurin'
        java-version: '17'

    - name: Run Karate Test
      if: ${{ env.SKIP_TESTS == 'false' }}
      id: run_karate_test
      run: |
        KARATE_OPTION="${{ steps.changed-feature-files.outputs.all_changed_files }} --tags ~@ignore"
        echo "KARATE_OPTIONS=$KARATE_OPTION" >> $GITHUB_ENV
        mvn -B -q clean test -DargLine="-Xmx6g" -fae -Dmaven.test.failure.ignore=true -Dkarate.options="${KARATE_OPTION} --threads 5" | tee karate-run.log
        
    - name: Read Karate JSON Result
      id: read-json
      if: ${{ env.SKIP_TESTS == 'false' }}
      uses: actions/github-script@v6
      with:
        script: |
          const fs = require('fs');
          const jsonString = fs.readFileSync('target/karate-reports/karate-summary-json.txt', 'utf8');
          const json = JSON.parse(jsonString);
          const testStatus = json.scenariosFailed > 0 || json.featuresFailed > 0 ? "FAILED üî¥" : "PASSED üü¢";
          const slackStatus = json.scenariosFailed > 0 ? 'FAILED :red_circle:' : 'PASSED :large_green_circle:';
          
          // Calculate efficiency
          const efficiency = json.threadTime > 0 ? (json.elapsedTime / json.threadTime).toFixed(2) : '0.00';
          
          // Log outputs for debug
          console.log(`Scenarios Passed: ${json.scenariosPassed}`);
          console.log(`Scenarios Failed: ${json.scenariosFailed}`);
          console.log(`Features Passed: ${json.featuresPassed}`);
          console.log(`Features Failed: ${json.featuresFailed}`);
          console.log(`Test Status: ${testStatus}`);
          console.log(`Elapsed Time: ${json.elapsedTime}s`);
          console.log(`Threads: ${json.threads}`);
          console.log(`Thread Time: ${json.threadTime}s`);
          console.log(`Efficiency: ${efficiency}`);
          
          core.setOutput('scenariosFailed', json.scenariosFailed || 0);
          core.setOutput('scenariosPassed', json.scenariosPassed || 0);
          core.setOutput('featuresFailed', json.featuresFailed || 0);
          core.setOutput('featuresPassed', json.featuresPassed || 0);
          core.setOutput('testStatus', testStatus);
          core.setOutput('slackStatus', slackStatus);
          core.setOutput('elapsedTime', json.elapsedTime || 0);
          core.setOutput('threads', json.threads || 5);
          core.setOutput('threadTime', json.threadTime || 0);
          core.setOutput('efficiency', efficiency);

    - name: Set Local Report URL
      if: ${{ env.SKIP_TESTS == 'false' }}
      run: |
        REPORT_URL="file://${{ github.workspace }}/target/karate-reports/karate-summary.html"
        echo "REPORT_URL=$REPORT_URL" >> $GITHUB_ENV

    - name: Upload Karate HTML Report
      if: ${{ env.SKIP_TESTS == 'false' }}
      uses: actions/upload-artifact@v4
      with:
        name: karate-html-report
        path: target/karate-reports/karate-summary.html

    - name: Output Report URL
      if: ${{ env.SKIP_TESTS == 'false' }}
      run: |
        echo "Report URL: $REPORT_URL"
        echo "## üìù [View Karate Summary Report]($REPORT_URL)" >> $GITHUB_STEP_SUMMARY

    - name: Hide previous comments
      uses: int128/hide-comment-action@v1
      with:
        contains: "ü•ã Karate Test Report"

    - name: Collect Failed Test Details (Console Log)
      if: ${{ env.SKIP_TESTS == 'false' }}
      id: collect-failures
      run: |
        FAILURES_FILE="target/karate-reports/failed-tests.txt"
        # Capture only scenario failure lines
        grep "<<< FAILURE!" karate-run.log | sed 's/Error: //g' > $FAILURES_FILE || true
        echo "failures<<EOF" >> $GITHUB_OUTPUT
        cat $FAILURES_FILE >> $GITHUB_OUTPUT
        echo "EOF" >> $GITHUB_OUTPUT

    - name: Run Gitleaks Secret Scan
      uses: gitleaks/gitleaks-action@v2
      with:
        args: detect --source . -v
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    - name: Comment on Pull Request
      if: ${{ env.SKIP_TESTS == 'false' }}
      uses: thollander/actions-comment-pull-request@v2
      with:
        message: |
          ### ü•ã Karate Test Report
          - **Status**: ${{ steps.read-json.outputs.testStatus }}
          - **Scenarios**: ${{ steps.read-json.outputs.scenariosPassed }} Passed | ${{ steps.read-json.outputs.scenariosFailed }} Failed
          - **Features**: ${{ steps.read-json.outputs.featuresPassed }} Passed | ${{ steps.read-json.outputs.featuresFailed }} Failed
          - üìù **[View Karate Summary Report](${{ env.REPORT_URL }})**
          #### ‚ùå Failed Scenarios (from console log)
          ```bash
          ${{ steps.collect-failures.outputs.failures }}
          ```
        GITHUB_TOKEN: ${{ secrets.KARATE_CICD_RW }}

    - name: Format and Send Slack Notification
      if: ${{ env.SKIP_TESTS == 'false' }}
      uses: actions/github-script@v6
      with:
        script: |
          const fs = require('fs');
          
          // Check if Slack webhook is configured
          const webhookUrl = process.env.SLACK_WEBHOOK;
          if (!webhookUrl || webhookUrl.trim() === '') {
            console.log('‚ö†Ô∏è  SLACK_WEBHOOK secret not configured. Skipping Slack notification.');
            return;
          }
          
          // Get test results from previous step
          const slackStatus = '${{ steps.read-json.outputs.slackStatus }}';
          const karateOptions = '${{ env.KARATE_OPTIONS }}' || 'Changed feature files';
          const elapsedTime = '${{ steps.read-json.outputs.elapsedTime }}';
          const threads = '${{ steps.read-json.outputs.threads }}';
          const threadTime = '${{ steps.read-json.outputs.threadTime }}';
          const efficiency = '${{ steps.read-json.outputs.efficiency }}';
          const featuresPassed = '${{ steps.read-json.outputs.featuresPassed }}';
          const featuresFailed = '${{ steps.read-json.outputs.featuresFailed }}';
          const scenariosPassed = '${{ steps.read-json.outputs.scenariosPassed }}';
          const scenariosFailed = '${{ steps.read-json.outputs.scenariosFailed }}';
          
          // Get workflow and run information
          const workflowName = context.workflow;
          const runId = context.runId;
          const repo = context.repo;
          const runUrl = `https://github.com/${repo.owner}/${repo.repo}/actions/runs/${runId}`;
          const reportUrl = '${{ env.REPORT_URL }}';
          
          // Format Slack message
          const slackMessage = `
          ${workflowName}
          Result: ${slackStatus}
          Karate Tags:
          ${karateOptions}
          Elapsed Time: ${elapsedTime}s | Threads: ${threads} | Thread Time: ${threadTime}s | Efficiency: ${efficiency}
          Features: Passed: ${featuresPassed} | Failed: ${featuresFailed}
          Scenarios: Passed: ${scenariosPassed} | Failed: ${scenariosFailed}
          :memo: <${reportUrl}|View Karate Summary Report>
          :link: <${runUrl}|View GitHub Run Details>
          `;
          
          // Send to Slack
          const https = require('https');
          const url = new URL(webhookUrl);
          
          const data = JSON.stringify({
            text: slackMessage.trim()
          });
          
          const options = {
            hostname: url.hostname,
            port: 443,
            path: url.pathname + url.search,
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'Content-Length': data.length
            }
          };
          
          return new Promise((resolve, reject) => {
            const req = https.request(options, (res) => {
              let responseData = '';
              res.on('data', (chunk) => {
                responseData += chunk;
              });
              res.on('end', () => {
                if (res.statusCode >= 200 && res.statusCode < 300) {
                  console.log('‚úÖ Slack notification sent successfully');
                  resolve();
                } else {
                  console.error(`‚ùå Slack notification failed: ${res.statusCode} - ${responseData}`);
                  reject(new Error(`Slack notification failed: ${res.statusCode}`));
                }
              });
            });
            
            req.on('error', (error) => {
              console.error('‚ùå Error sending Slack notification:', error);
              reject(error);
            });
            
            req.write(data);
            req.end();
          });
      env:
        SLACK_WEBHOOK: ${{ secrets.SLACK_WEBHOOK }}

    - name: Validate PR Checklist
      if: github.event_name == 'pull_request'
      uses: actions/github-script@v6
      with:
        script: |
          const body = context.payload.pull_request.body || "";
          // Each required checklist item must be checked ([x]) in the PR body
          const required = [
            "CI/CD check test report has been reviewed with no failures",
            "Description of PR has been included",
            "Correct labels have been added",
            "Tests have been run on changes made and all tests should pass",
            "PR has been assigned to yourself",
            "At least 2 reviewers have been added"
          ];
          const missing = required.filter(item => !body.includes(`[x] ${item}`));
          if (missing.length > 0) {
            core.setFailed(`‚ùå Checklist validation failed. Missing or unchecked items:\n${missing.join("\n")}`);
          } else {
            console.log("‚úÖ All required checklist items checked.");
          }

    - name: Fail if Tests Failed
      if: ${{ env.SKIP_TESTS == 'false' && steps.read-json.outputs.testStatus == 'FAILED üî¥' }}
      uses: actions/github-script@v6
      with:
        script: |
          core.setFailed('Test execution completed with some failures. Exiting with status code 1.')

